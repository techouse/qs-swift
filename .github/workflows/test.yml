name: Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_call:

permissions:
  contents: read

concurrency:
  group: test-${{ github.ref }}
  cancel-in-progress: true

jobs:
  style:
    name: Code style (SwiftPM) + cache warmup
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Show Swift version (runner default)
        run: swift --version
      - name: Build (debug)
        run: swift build --disable-sandbox

  tests:
    name: Swift tests + coverage (${{ matrix.os }}, Swift ${{ matrix.swift }})
    runs-on: ${{ matrix.os }}
    needs: style
    strategy:
      fail-fast: false
      matrix:
        os:
          - macos-latest
          # - ubuntu-latest ## Disabled due to https://github.com/swift-actions/setup-swift/issues/739
        swift:
          - '5.10'
          - '6'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Swift ${{ matrix.swift }}
        uses: swift-actions/setup-swift@v2
        with:
          swift-version: ${{ matrix.swift }}

      - name: Show Swift toolchain
        run: swift --version

      - name: Install llvm-cov (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y llvm

      - name: Confirm 5.10 manifest in use
        if: matrix.swift == '5.10'
        run: |
          set -e
          swift package dump-package > manifest.json
          if grep -q 'swift-testing' manifest.json; then
            echo "Using Package@swift-5.10.swift ✅"
          else
            echo "Not using 5.10 manifest ❌"
            cat manifest.json
            exit 1
          fi

      - name: Route raw profiles to a writable place
        run: |
          set -e
          mkdir -p $RUNNER_TEMP/profraw
          export LLVM_PROFILE_FILE=$RUNNER_TEMP/profraw/default.profraw

      - name: Run tests with coverage
        env:
          SWIFT_DETERMINISTIC_HASHING: 1
        run: bash scripts/coverage.sh

      - name: Collect macOS crash logs
        if: ${{ failure() && runner.os == 'macOS' }}
        run: |
          mkdir -p crashlogs
          find ~/Library/Logs/DiagnosticReports -name "*.crash" -mmin -10 -print -exec cp {} crashlogs/ \; || true
      - uses: actions/upload-artifact@v4
        if: ${{ failure() && runner.os == 'macOS' }}
        with:
          name: macOS-crashlogs
          path: crashlogs

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: coverage/info.lcov
          flags: swift,${{ matrix.os }},swift-${{ matrix.swift }}
          name: Qs-swift-${{ matrix.os }}-swift-${{ matrix.swift }}
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
