name: Test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_call:

permissions:
  contents: read

concurrency:
  group: test-${{ github.ref }}
  cancel-in-progress: true

env:
  XCODE_VERSION: '16.3'
  SWIFT_VERSION: '6.1'

jobs:
  analyze:
    permissions:
      contents: read
    name: SwiftLint
    runs-on: macos-15
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Select Xcode ${{ env.XCODE_VERSION }}
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - name: Show Xcode & Swift versions
        run: |
          xcodebuild -version
          swift --version

      - name: Install SwiftLint
        run: |
          set -euo pipefail
          brew update
          brew install swiftlint
          swiftlint version

      - name: Run SwiftLint
        run: |
          set -euo pipefail
          swiftlint lint --reporter github-actions-logging

  tests:
    permissions:
      contents: read
    name: Swift tests + coverage (macOS, Xcode)
    timeout-minutes: 45
    runs-on: macos-15
    needs: analyze
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Select Xcode ${{ env.XCODE_VERSION }}
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - name: Show Xcode & Swift versions
        run: |
          xcodebuild -version
          swift --version

      - name: Cache SwiftPM artifacts
        uses: actions/cache@v4
        with:
          path: |
            ~/.swiftpm
            .build
            ~/Library/Caches/org.swift.swiftpm
          key: spm-${{ runner.os }}-swift-${{ env.SWIFT_VERSION }}-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            spm-${{ runner.os }}-swift-${{ env.SWIFT_VERSION }}-

      - name: Run tests with coverage
        env:
          SKIP_EXPENSIVE_TESTS: 1
          SWIFT_DETERMINISTIC_HASHING: 1
        run: bash scripts/coverage.sh

      - name: Collect macOS crash logs
        if: ${{ failure() }}
        run: bash scripts/collect-macos-crashlogs.sh crashlogs

      - name: Upload macOS crash logs (if any)
        if: ${{ failure() }}
        uses: actions/upload-artifact@v4
        with:
          name: macOS-crashlogs-xcode-${{ env.XCODE_VERSION }}-swift-${{ env.SWIFT_VERSION }}
          path: crashlogs
          if-no-files-found: ignore

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: coverage/info.lcov
          flags: swift,macos-15,xcode-${{ env.XCODE_VERSION }},swift-${{ env.SWIFT_VERSION }}
          name: QsSwift-macos-15-xcode-${{ env.XCODE_VERSION }}-swift-${{ env.SWIFT_VERSION }}
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  objc-tests:
    permissions:
      contents: read
    name: Objective-C E2E tests (macOS, Xcode)
    timeout-minutes: 45
    runs-on: macos-15
    needs: [ analyze, tests ]
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Select Xcode ${{ env.XCODE_VERSION }}
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - name: Show Xcode & Swift versions
        run: |
          xcodebuild -version
          swift --version

      - name: Warn if Swift toolchain doesnâ€™t match env.SWIFT_VERSION
        run: |
          set -euo pipefail
          swift --version | tee swift-version.txt
          if ! swift --version | grep -q "${{ env.SWIFT_VERSION }}"; then
            echo "::warning::Swift toolchain version differs from SWIFT_VERSION=${{ env.SWIFT_VERSION }}."
          fi

      - name: Work around stale local SwiftPM path (symlink)
        run: |
          set -euxo pipefail
          # Some SPM/Xcode setups expect the package folder name "QsSwift" (package name)
          # while the repo slug is "qs-swift"; create/refresh a sibling symlink to avoid stale paths.
          ACTUAL="${GITHUB_WORKSPACE}"
          PARENT="$(dirname "$ACTUAL")"
          EXPECTED="${PARENT}/QsSwift"
          if ! test -w "$PARENT"; then
            echo "Parent $PARENT not writable; skipping symlink workaround."
            exit 0
          fi
          mkdir -p "$PARENT"
          # Idempotent: force-create/refresh the symlink
          if [ -e "$EXPECTED" ] && [ ! -L "$EXPECTED" ]; then
            echo "Error: $EXPECTED exists and is not a symlink. Refusing to remove it." >&2
            exit 1
          fi
          if [ -L "$EXPECTED" ]; then
            TARGET="$(readlink "$EXPECTED")"
            if [ "$TARGET" != "$ACTUAL" ]; then
              echo "Refreshing symlink: $EXPECTED -> $ACTUAL (was $TARGET)"
            fi
          fi
          ln -sfn "$ACTUAL" "$EXPECTED"
          ls -lah "$PARENT" || true
          ls -lah "$EXPECTED" || true

      - name: Cache SPM (Xcode)
        uses: actions/cache@v4
        with:
          path: |
            ~/.swiftpm
            ~/Library/Developer/Xcode/DerivedData/SourcePackages
            .derivedData-objc/SourcePackages
          key: spm-${{ runner.os }}-xcode-${{ env.XCODE_VERSION }}-swift-${{ env.SWIFT_VERSION }}-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            spm-${{ runner.os }}-xcode-${{ env.XCODE_VERSION }}-swift-${{ env.SWIFT_VERSION }}-

      - name: Resolve SPM dependencies (ObjC test project)
        run: |
          set -euxo pipefail
          xcodebuild \
            -project ObjCE2ETests/ObjCE2ETests.xcodeproj \
            -scheme ObjCE2ETests \
            -derivedDataPath .derivedData-objc \
            -resolvePackageDependencies

      - name: Run Objective-C tests (macOS)
        env:
          NSUnbufferedIO: "YES"
        run: |
          set -euxo pipefail
          xcodebuild -quiet \
            -project ObjCE2ETests/ObjCE2ETests.xcodeproj \
            -scheme ObjCE2ETests \
            -configuration Debug \
            -derivedDataPath .derivedData-objc \
            -destination "platform=macOS" -sdk macosx \
            CODE_SIGNING_ALLOWED=NO \
            -disableAutomaticPackageResolution \
            -enableCodeCoverage YES \
            -resultBundlePath ObjC-Tests.xcresult \
            test

      - name: Zip .xcresult and extract xccov JSON
        run: |
          set -euxo pipefail
          test -d ObjC-Tests.xcresult
          /usr/bin/zip -qry ObjC-Tests.xcresult.zip ObjC-Tests.xcresult
          xcrun xccov view --report --json ObjC-Tests.xcresult > objc-coverage.json

      - name: Upload Objective-C coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: |
            ${{ github.workspace }}/ObjC-Tests.xcresult.zip
            ${{ github.workspace }}/objc-coverage.json
          flags: objc,macos-15,xcode-${{ env.XCODE_VERSION }}
          name: QsSwift-ObjC-macos-15-xcode-${{ env.XCODE_VERSION }}
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

      - name: Upload ObjC test result bundle
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: ObjC-Tests-xcode-${{ env.XCODE_VERSION }}
          path: ObjC-Tests.xcresult
          if-no-files-found: warn

      - name: Collect macOS crash logs (ObjC job)
        if: ${{ failure() }}
        run: bash scripts/collect-macos-crashlogs.sh crashlogs-objc

      - name: Upload macOS crash logs (ObjC job, if any)
        if: ${{ failure() }}
        uses: actions/upload-artifact@v4
        with:
          name: macOS-crashlogs-objc-xcode-${{ env.XCODE_VERSION }}-macos-15
          path: crashlogs-objc
          if-no-files-found: ignore

  linux-tests:
    permissions:
      contents: read
    name: Swift tests (Linux)
    runs-on: ubuntu-latest
    timeout-minutes: 40
    continue-on-error: true
    needs: analyze
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup Swift ${{ env.SWIFT_VERSION }}
        uses: swift-actions/setup-swift@v2
        with:
          swift-version: ${{ env.SWIFT_VERSION }}

      - name: Show Swift & OS versions
        run: |
          swift --version
          uname -a

      - name: Cache SwiftPM artifacts (Linux)
        uses: actions/cache@v4
        with:
          path: |
            ~/.swiftpm
            .build
            ~/.cache/org.swift.swiftpm
          key: spm-${{ runner.os }}-swift-${{ env.SWIFT_VERSION }}-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            spm-${{ runner.os }}-swift-${{ env.SWIFT_VERSION }}-

      - name: Run tests (Linux)
        env:
          SKIP_EXPENSIVE_TESTS: 1
          SWIFT_DETERMINISTIC_HASHING: 1
        run: bash scripts/coverage.sh

      - name: Kernel logs on failure
        if: ${{ failure() }}
        run: |
          set -euxo pipefail
          dmesg | tail -n 200 || true

  ensure-compatibility:
    name: Ensure compatibility with qs.js
    needs: [ analyze, tests ]
    runs-on: macos-15
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Select Xcode ${{ env.XCODE_VERSION }}
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - name: Show Xcode & Swift versions
        run: |
          xcodebuild -version
          swift --version

      - name: Cache SwiftPM artifacts
        uses: actions/cache@v4
        with:
          path: |
            ~/.swiftpm
            .build
            ~/Library/Caches/org.swift.swiftpm
            Tools/QsSwiftComparison/.build
          key: spm-${{ runner.os }}-xcode-${{ env.XCODE_VERSION }}-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            spm-${{ runner.os }}-xcode-${{ env.XCODE_VERSION }}-

      - name: Install Node.js (with npm cache)
        uses: actions/setup-node@v5
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: Tools/QsSwiftComparison/js/package-lock.json

      - name: Install qs.js
        working-directory: Tools/QsSwiftComparison/js
        run: npm ci --no-audit --no-fund

      - name: Show qs.js version
        working-directory: Tools/QsSwiftComparison/js
        run: |
          node --version
          npm --version
          echo "qs version: $(node -p "require('qs/package.json').version")"

      - name: Compare Swift vs qs.js outputs (deterministic)
        working-directory: Tools/QsSwiftComparison
        env:
          SWIFT_DETERMINISTIC_HASHING: 1
          LC_ALL: C
        run: bash compare_outputs.sh
